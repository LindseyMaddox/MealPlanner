<%= render 'shared/recipe_link.html.erb' %>

<div class = "row">
  <div class="col-sm-3"></div>
  <div class="col-sm-6 heading">  
    <h4>This Week's Meal suggestions are:</h4>
  </div>
</div>
</br>
<div class = "row">
  <div class="col-sm-3"></div>
  <div class="col-sm-6">
    <div class="row subheading">
      <div class="col-sm-6">Meal</div>
    </div>
  </div>
</div>  
<div class = "row">
  <div class="col-sm-3"></div>
  <div class="col-sm-6 meal-suggestions">
    <% @this_week_meals.each do |meal| %>
      <div class="row meal">
        <div class="col-sm-6">
          <%= link_to meal.name, recipe_path(meal.recipe_id) %>
           <%=  hidden_field_tag :recipe_id, value: meal.recipe_id %>
        </div>
      </div>
    <% end %>
  </div>
  <div class="col-sm-3">
    <div class="row">
       <div class="col-sm-12"> <strong>Filter by Date</strong></div>
          <div class="col-sm-12">
              <% @number_of_meals.each_pair do |text, number| %>
                <li>
                  <%= link_to "#{text}", planner_meals_path(number_of_meals: number), class: 'label label-primary' %>
                </li>
              <% end %>
          </div>
        </div>
    </div>
  </div>
</br>
</br>
<div class="row">
  <div class="col-sm-3"></div>
  <div class="col-sm-6">Filter by grain:</div>
</div>
<div class="row">
  <div class="col-sm-3"></div>
  <div class="col-sm-6">
     <% @grains.each do |grain| %>
      <% unless grain == @grains.last %>
       <%= link_to grain.name, planner_meals_path(grain_requests: grain.id) %>,
      <% else %>
        <%= link_to grain.name, planner_meals_path(grain_requests: grain.id) %>
      <% end %>
    <% end %>
  </div>
</div>
  <%# Need to figure out appropriate layout for this section %>
  <%#<div class="col-sm-3"><p>Summary: This week, you're making <% @difficult_items.length %><%#</div></p> %>

    <%# 
    It is impossible to have more than 3 items with a value of 2 or higher, so you only
    need 3 conditions. 
    
 %>

<div class="row">
  <div class="col-sm-4"></div>
  <div class="col-sm-3">
    <button class="btn btn-success save">
      Save Meal Plan
    </button>
  </div>
</div>
</br>
<script type="text/javascript"> 
$(function () {
    var saveButton = $('.save');


//currently basing date on tomorrow + 1 for each new recipe
   
   var date = new Date(Date.now());



    saveButton.on("click", function() {
        var hiddenElements = $( "body" ).find( ":hidden" ).not( "script" );

     var date = new Date(Date.now());
     var dataArr = [];
       // for now, doing regex to get the id val

        
       for(var i=0; i<hiddenElements.length; i++){
        var tempHash = {}
        var val = hiddenElements[i].value;
       // get the value only. returns an array, so get the first index of that array
        var recipeId = val.match(/\d+/g)[0];
        
     //   date is getting reset every time, so you only need to add 1
        date.setDate(date.getDate() + 1);
        var month = Number(date.getMonth()) + 1
           if(month < 10){
             month = "0" + month;
           }
        var dateDbFormat = date.getFullYear() + "-" + month + "-" + date.getDate();
        tempHash["recipe_id"] = recipeId;
        tempHash["meal_date"] = dateDbFormat;

       
         dataArr.push(tempHash);
       }
      
       $.ajax({
            url:'/meals/batch_create',
             type: 'POST',
             dataType: 'json',
             contentType: 'application/json',
             data: JSON.stringify(dataArr),
              headers: {
               'X-Transaction': 'POST Example',
               'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
             },
         //    success handled by the controller
            error: function (jqXHR, textStatus, errorThrown) {
             //     may want to do flash instead
                 alert("could not save this meal");
             }
         });
    });

});

</script>
<div class="row">
  <div class="col-sm-3"></div>
  <div class="col-sm-2"><%= link_to "home", recipes_path %></div>
  <div class="col-sm-3"><%= link_to "See Last Week's Meals", meal_plans_path(date_filter: 7) %></div>
</div>